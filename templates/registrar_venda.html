<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Venda - P√£o FresQUIM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #F8F8F8; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 900px; 
            margin: 20px auto; 
            background-color: #FFF; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); 
        }
        h2 { 
            text-align: center; 
            color: #000; 
            margin-bottom: 30px; 
            border-bottom: 2px solid #E0E0E0; 
            padding-bottom: 10px; 
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        label { 
            display: block; 
            font-weight: bold; 
            margin-bottom: 5px; 
        }
        input[type="number"], select, input[type="text"] { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #CCC; 
            border-radius: 5px; 
            box-sizing: border-box; 
        }
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: background-color 0.3s; 
        }
        .btn-success { 
            background-color: #28A745; 
            color: white; 
        }
        .btn-success:hover { 
            background-color: #218838; 
        }
        .btn-primary { 
            background-color: #007BFF; 
            color: white; 
        }
        .btn-primary:hover { 
            background-color: #0056b3; 
        }

        /* Estilo para a tabela de itens */
        #itens-container { 
            border-collapse: collapse; 
            width: 100%; 
            margin-top: 20px; 
        }
        #itens-container tbody tr { 
            border-bottom: 1px solid #EEE; 
        }
        .item-row td { 
            padding: 8px 0; 
            vertical-align: middle; 
        }

        /* Estilo para a box do Total */
        .total-box { 
            background-color: #f6f6f6; 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: 25px;
            text-align: right;
            font-size: 1.0em;
        }
        #display-total { 
            font-size: 2.0em; 
            color: #007BFF; 
            font-weight: bold; 
            display: block; 
            margin-top: 5px;
        }
        .message { padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .error { background-color: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        .success { background-color: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        
    .actions-cell {
    text-align: center; /* Centraliza horizontalmente o bot√£o */
    vertical-align: middle; /* Centraliza verticalmente na linha da tabela */
}

/* 2. ESTILIZA O BOT√ÉO (OPCIONAL, MAS LIMPA O VISUAL) */
    .remove-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px; /* Adiciona um pequeno espa√ßamento de clique */
        line-height: 1; /* Garante que o √≠cone ocupe o espa√ßo correto */
    }

/* 3. AUMENTA O TAMANHO DO √çCONE E DEFINE A COR */
    .remove-btn .fa-trash {
    /* Aumenta o tamanho da fonte (ex: 1.5 vezes o tamanho padr√£o) */
        font-size: 1.5em; 
        color: #DC3545; /* Cor vermelha padr√£o para exclus√£o */
        transition: color 0.2s; /* Efeito de transi√ß√£o suave */
    }

    .remove-btn:hover .fa-trash {
        color: #C82333; /* Fica um pouco mais escuro ao passar o mouse */
    }
        
        /* Ajuste para input de desconto */
        #desconto_final {
            width: 150px !important;
            display: inline-block;
            text-align: right;
        }

         .back-link {
            display: inline-block;
            margin-top: 40px;
            padding: 12px 25px;
            background-color: #EEE;
            color: #333;
            border-radius: 8px;
            text-decoration: none;
            font-size: 1.2em;
            transition: background-color 0.3s;
        }
        
        .back-link:hover {
            background-color: #DDD;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2><i class="fas fa-cash-register"></i> Registro de Nova Venda</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('registrar_venda') }}" id="venda-form">
            
            <div class="form-group">
                <label for="cliente_id">Cliente:</label>
                <select name="cliente_id" id="cliente_id">
                    <option value="">(Venda no Balc√£o)</option>
                    {% for cliente in clientes %}
                        <option value="{{ cliente.id }}">
                            {{ cliente.nome }} (CPF: {{ cliente.cpf }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <hr style="margin: 20px 0;">

            <h3>Itens da Venda</h3>
            <table id="itens-container">
                <thead>
                    <tr>
                        <th style="width: 50%; text-align: left;">Produto</th>
                        <th style="width: 20%; text-align: center;">Pre√ßo Unit.</th>
                        <th style="width: 15%; text-align: center;">Qtd</th>
                        <th style="width: 15%;"></th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>

            <button type="button" class="btn btn-primary" onclick="adicionarItem()" style="margin-top: 15px;">
                <i class="fas fa-plus"></i> Adicionar Produto
            </button>
            
            <hr style="margin: 20px 0;">

            <div class="row-footer" style="display: flex; justify-content: flex-end; gap: 30px; margin-top: 20px; padding-right: 15px;">
    
    <div class="form-group" style="text-align: right; width: 250px;">
        <label for="desconto_final" style="display: block; text-align: right;">Desconto (R$):</label>
        <input type="number" id="desconto_final" name="desconto_final" step="0.01" value="0.00" onchange="calcularTotalFinal()" style="text-align: right;">
    </div>

    <div class="form-group" style="text-align: right; width: 250px;">
        <label for="forma_pagamento" style="display: block; text-align: right;">Forma de Pagamento:</label>
        <select name="forma_pagamento" id="forma_pagamento" required style="width: 100%;">
            <option value="">Selecione a Forma de Pagamento</option>
            <option value="Pix">Pix</option>
            <option value="Dinheiro">Dinheiro</option>
            <option value="Cartao_Debito">Cart√£o de D√©bito</option>
            <option value="Cartao_Credito">Cart√£o de Cr√©dito</option>
            <option value="A_Prazo" id="option_a_prazo">A Prazo (Credi√°rio)</option>
            </select>
        </div>
    </div>


            <div class="total-box">
                Subtotal: <span id="display-subtotal">{{ 0.00 | formatar_moeda }}</span><br>
                Desconto: <span id="display-desconto">{{ 0.00 | formatar_moeda }}</span><br>
                Total: <span id="display-total">{{ 0.00 | formatar_moeda }}</span>
            </div>

            <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 20px; font-size: 1.3em;">
                <i class="fas fa-check"></i> Finalizar Venda
            </button>
        </form>
        
        <p style="text-align: center; margin-top: 20px;">
            <a href="{{ url_for('menu_vendas') }}" class="back-link">
                <i class="fas fa-arrow-left" style="color: #000000;"></i> Voltar
            </a>
        </p>

    </div>

   <script>
        (function() {
            // üöÄ Lista de produtos injetada pelo Flask (serializada)
            const LISTA_PRODUTOS_STRING = '{{ produtos | tojson | safe }}';
            const LISTA_PRODUTOS = JSON.parse(LISTA_PRODUTOS_STRING);

            // üöÄ NOVO: Lista de clientes injetada pelo Flask
            const LISTA_CLIENTES_STRING = '{{ clientes | tojson | safe }}';
            const LISTA_CLIENTES = JSON.parse(LISTA_CLIENTES_STRING);

            let itemIdCounter = 0;
            const itensContainer = document.querySelector('#itens-container tbody');
            const clienteSelect = document.getElementById('cliente_id');
            const aPrazoOption = document.getElementById('option_a_prazo');

            // ----------------------------------------------------
            // üí° FUN√á√ÉO DE FORMATA√á√ÉO
            // ----------------------------------------------------
            function formatarMoeda(valor) {
                // Formata√ß√£o R$ X.XXX,XX
                return "R$ " + valor.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            }
            
            // ----------------------------------------------------
            // üí° NOVO: FUN√á√ÉO DE VALIDA√á√ÉO DE CR√âDITO
            // ----------------------------------------------------
            window.validarCredito = function() {
                const clienteId = clienteSelect.value;
                const formaPagamentoSelect = document.getElementById('forma_pagamento');

                // 1. Venda no Balc√£o (Nenhum Cliente Selecionado)
                if (!clienteId) {
                    aPrazoOption.disabled = true;
                    aPrazoOption.textContent = 'A Prazo (Requer Cliente)';
                    if (formaPagamentoSelect.value === 'A_Prazo') {
                        formaPagamentoSelect.value = ''; // Reseta a sele√ß√£o
                    }
                    return;
                }

                // 2. Busca o status do cliente
                // O m√©todo find retorna o primeiro cliente que satisfaz a condi√ß√£o
                const cliente = LISTA_CLIENTES.find(c => c.id == clienteId);

                if (cliente && cliente.status_credito === 'Negado') {
                    // Cr√©dito Negado (simulando Serasa)
                    aPrazoOption.disabled = true;
                    aPrazoOption.textContent = 'A Prazo (Cr√©dito Negado - Serasa)';
                    
                    // Se o usu√°rio selecionou 'A Prazo', a sele√ß√£o √© removida.
                    if (formaPagamentoSelect.value === 'A_Prazo') {
                        formaPagamentoSelect.value = '';
                    }

                } else {
                    // Cr√©dito Aprovado ou Pendente (Permitido)
                    aPrazoOption.disabled = false;
                    aPrazoOption.textContent = 'A Prazo (Credi√°rio)';
                }
            };


            // ----------------------------------------------------
            // üí° FUN√á√ÉO PRINCIPAL DE C√ÅLCULO (AJUSTADA PARA DESCONTO)
            // ----------------------------------------------------
            window.calcularTotal = function() {
                let subtotal = 0;
                const rows = itensContainer.querySelectorAll('.item-row');
                
                rows.forEach(row => {
                    const select = row.querySelector('select[name="produto_id[]"]');
                    const input = row.querySelector('input[name="quantidade[]"]');
                    const precoDisplay = row.querySelector('.preco-unitario-display');
                    
                    if (select && input) {
                        const selectedOption = select.options[select.selectedIndex];
                        const valorStr = selectedOption.getAttribute('data-valor');
                        const valor = parseFloat(valorStr);
                        const quantidade = parseInt(input.value);
                        
                        // Atualiza o display de pre√ßo unit√°rio da linha
                        if (precoDisplay) {
                            precoDisplay.textContent = formatarMoeda(isNaN(valor) ? 0 : valor);
                        }

                        if (!isNaN(valor) && !isNaN(quantidade) && quantidade > 0) {
                            subtotal += valor * quantidade;
                        }
                    }
                });

                // Captura e valida o desconto
                const descontoInput = document.getElementById('desconto_final');
                let valorDesconto = 0.0;
                if (descontoInput) {
                    valorDesconto = parseFloat(descontoInput.value.replace(',', '.'));
                    if (isNaN(valorDesconto) || valorDesconto < 0) {
                         valorDesconto = 0.0;
                    }
                }
                
                // Calcula o total final
                let total = subtotal - valorDesconto;
                if (total < 0) {
                    total = 0;
                }

                // Atualiza os displays
                document.getElementById('display-subtotal').textContent = formatarMoeda(subtotal);
                document.getElementById('display-desconto').textContent = formatarMoeda(valorDesconto);
                document.getElementById('display-total').textContent = formatarMoeda(total);
            };

            // ----------------------------------------------------
            // üí° FUN√á√ïES DE ITEM (Adicionar/Remover)
            // ----------------------------------------------------
            window.adicionarItem = function() {
                itemIdCounter++;
                const row = document.createElement('tr');
                row.className = 'item-row';
                row.id = `row-${itemIdCounter}`;
                
                // Op√ß√µes de produto (Select)
                let options = `<option value="" data-valor="0">Selecione um Produto</option>`;
                LISTA_PRODUTOS.forEach(p => {
                    options += `<option value="${p.id}" data-valor="${p.valor}">
                                        ${p.nome}
                                    </option>`;
                });

                row.innerHTML = `
                    <td>
                        <select name="produto_id[]" required onchange="calcularTotal()">
                            ${options}
                        </select>
                    </td>
                    <td style="text-align: center;" class="preco-unitario-display">R$ 0.00</td>
                    <td style="text-align: center;">
                        <input type="number" name="quantidade[]" value="1" min="1" required 
                                style="width: 80px; text-align: center;" oninput="calcularTotal()">
                    </td>
                    <td class="actions-cell">
                        <button type="button" class="remove-btn" onclick="removerItem('row-${itemIdCounter}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    </td>
                `;
                
                itensContainer.appendChild(row);
                calcularTotal();
            };

            window.removerItem = function(rowId) {
                const row = document.getElementById(rowId);
                if (row) {
                    row.remove();
                    calcularTotal();
                }
            };
            
            // ----------------------------------------------------
            // üí° INICIALIZA√á√ÉO (Update)
            // ----------------------------------------------------
            document.addEventListener('DOMContentLoaded', () => {
                adicionarItem(); // Adiciona o primeiro item
                
                // Garante que o input de desconto comece com 0.00
                const descontoInput = document.getElementById('desconto_final');
                if (descontoInput) {
                    descontoInput.value = (0).toFixed(2);
                }

                // NOVO: Adiciona o listener para valida√ß√£o de cr√©dito
                clienteSelect.addEventListener('change', validarCredito);
                
                // Roda a valida√ß√£o inicial para desabilitar A Prazo se Venda no Balc√£o
                validarCredito();
            });

        })();
    </script>
</body>
</html>